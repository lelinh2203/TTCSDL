CREATE PROC sp_GetAllLichSuTiem (@MAKH CHAR(10))
AS
BEGIN
	SELECT pt.NGAYTIEM, vc.TENVACCINE, ctt.LIEULUONG, lvc.LOAIVACCINE, vc.DONGIA
    FROM dbo.KHACHHANG kh INNER JOIN dbo.PHIEUTIEM pt INNER JOIN dbo.CHITIETTIEM ctt INNER JOIN dbo.VACCINE vc INNER JOIN dbo.LOAIVC lvc
	ON VC.MALOAIVC = lvc.MALOAIVC
    ON vc.MAVACCINE = ctt.MAVACCINE
    ON ctt.MAPHIEUTIEM = pt.MAPHIEUTIEM
    ON pt.MAKH = kh.MAKH
    WHERE kh.MAKH = @MAKH
END
GO



CREATE PROC sp_GetTenThuNgan (@MATHUNGAN char(10))
AS
BEGIN
	SELECT HOTEN FROM THUNGAN WHERE MATHUNGAN = @MATHUNGAN
END
GO



CREATE PROC sp_GetAllVaccine
AS
BEGIN
    SELECT vc.MAVACCINE, vc.TENVACCINE, vc.NHASX, vc.NGAYSX, vc.HANSD, vc.SOLO, vc.SOLUONGCOSAN, vc.DONGIA, lvc.LOAIVACCINE
	FROM dbo.VACCINE vc INNER JOIN dbo.LOAIVC lvc ON lvc.MALOAIVC = vc.MALOAIVC
END
GO



CREATE PROC sp_SearchAllVaccine (@Value NVARCHAR(100))
AS
BEGIN
    SELECT vc.MAVACCINE, vc.TENVACCINE, vc.NHASX, vc.NGAYSX, vc.HANSD, vc.SOLO, vc.SOLUONGCOSAN, vc.DONGIA, lvc.LOAIVACCINE
	FROM dbo.VACCINE vc INNER JOIN dbo.LOAIVC lvc ON lvc.MALOAIVC = vc.MALOAIVC
    WHERE vc.MAVACCINE LIKE N'%' + @Value + '%'
    OR vc.TENVACCINE LIKE N'%' + @Value + '%'
    OR vc.NHASX LIKE N'%' + @Value + '%'
    OR vc.NGAYSX LIKE N'%' + @Value + '%'
    OR vc.HANSD  LIKE N'%' + @Value + '%'
    OR vc.SOLO LIKE N'%' + @Value + '%'
    OR vc.SOLUONGCOSAN LIKE N'%' + @Value + '%'
    OR lvc.LOAIVACCINE LIKE N'%' + @Value + '%'
    OR vc.DONGIA LIKE N'%' + @Value + '%'
END
GO



CREATE PROC sp_IsVCInStock (@MAVACCINE CHAR(10))
AS
BEGIN
	DECLARE @returnVal int
	IF EXISTS (SELECT MAVACCINE FROM VACCINE WHERE MAVACCINE = @MAVACCINE)
	BEGIN
	    SET @returnVal = 1
	END
	ELSE SET @returnVal = 0
	RETURN @returnVal
END
GO



CREATE PROC sp_InsertPhieuTiem (@MAPHIEUTIEM CHAR(10), @NGAYTIEM DATE, @MAKH CHAR(10), @MABS CHAR(10)) 
AS
BEGIN
    INSERT INTO dbo.PHIEUTIEM
    (
        MAPHIEUTIEM,
        NGAYTIEM,
        MAKH,
        MABS
    )
    VALUES
    (   @MAPHIEUTIEM,        -- MAPHIEUTIEM - char(10)
        @NGAYTIEM, -- NGAYTIEM - date
        @MAKH,        -- MAKH - char(10)
        @MABS         -- MABS - char(10)
        )
END
GO	



CREATE PROC sp_InsertCTT (@MAPHIEUTIEM CHAR(10),@MAVACCINE CHAR(10), @GIABAN INT, @MUITHU INT, @NGAYNHACLAI DATE, @LIEULUONG FLOAT)
AS
BEGIN
    INSERT INTO dbo.CHITIETTIEM
    (
        MAPHIEUTIEM,
        MAVACCINE,
        GIABAN,
        MUITHU,
        NGAYTIEMNHACLAI,
        LIEULUONG
    )
    VALUES
    (   @MAPHIEUTIEM,        -- MAPHIEUTIEM - char(10)
        @MAVACCINE,        -- MAVACCINE - char(10)
        @GIABAN,         -- GIABAN - int
        @MUITHU,         -- MUITHU - int
        @NGAYNHACLAI, -- NGAYTIEMNHACLAI - date
        @LIEULUONG        -- LIEULUONG - float
        )
END
GO	


CREATE PROC sp_DeletePhieuTiem (@MAPHIEUTIEM CHAR(10))
AS	
BEGIN
    DELETE dbo.PHIEUTIEM WHERE MAPHIEUTIEM = @MAPHIEUTIEM
END
GO


CREATE PROC sp_GetPhieuTiemsInfo 
AS
BEGIN
    SELECT pt.MAPHIEUTIEM, pt.NGAYTIEM, bs.HOTEN AS TENBS, kh.TENKH, kh.NGAYSINH, kh.GIOITINH, kh.TIEUSU
	FROM dbo.BACSY bs INNER JOIN dbo.PHIEUTIEM pt INNER JOIN dbo.KHACHHANG kh
	ON kh.MAKH = pt.MAKH
	ON pt.MABS = bs.MABS
	ORDER BY pt.MAPHIEUTIEM DESC
END
GO	


CREATE PROC sp_UpdatePhieuTiemInfo (@MAPHIEUTIEM CHAR(10), @NGAYTIEM DATE, @TENKH NVARCHAR(50), @NGAYSINH DATE, @GIOITINH NVARCHAR(4), @TIEUSU NVARCHAR(250))
AS
BEGIN
    UPDATE dbo.PHIEUTIEM SET NGAYTIEM = @NGAYTIEM WHERE MAPHIEUTIEM = @MAPHIEUTIEM
	UPDATE dbo.KHACHHANG SET TENKH = @TENKH, NGAYSINH = @NGAYSINH, GIOITINH = @GIOITINH, TIEUSU = @TIEUSU WHERE MAKH IN
	(
		SELECT kh.MAKH FROM dbo.KHACHHANG kh INNER JOIN  dbo.PHIEUTIEM pt ON pt.MAKH = kh.MAKH WHERE pt.MAPHIEUTIEM = @MAPHIEUTIEM
	)
END
GO	

CREATE PROC sp_GetAllHoaDonInfo
AS
BEGIN
    SELECT hd.MAHOADON, hd.TONGTIEN, hd.CHIETKHAU, hd.NGAYTHU, ngh.HOTEN AS NGUOIGH, ngh.DIACHI, ngh.SDT, kh.TENKH AS KHACHHANG, tn.HOTEN AS THUNGAN
	FROM dbo.THUNGAN tn INNER JOIN dbo.HOADON hd INNER JOIN dbo.KHACHHANG kh INNER JOIN dbo.NGUOIGIAMHO ngh
	ON ngh.MAGH = kh.MAGH
	ON	kh.MAGH = hd.MAGH
	ON hd.MATHUNGAN = tn.MATHUNGAN
END
GO	


CREATE PROC sp_GetMaPhieuTiemFromHD (@MAHOADON CHAR(10))
AS
BEGIN
    SELECT MAPHIEUTIEM FROM dbo.HOADON WHERE MAHOADON = @MAHOADON
END
GO	


CREATE PROC sp_DeleteHoaDon (@MAHOADON CHAR(10))
AS
BEGIN
    DELETE FROM dbo.HOADON WHERE MAHOADON = @MAHOADON
END
GO	


CREATE PROC sp_UpdateHoaDonInfo (@MAHOADON CHAR(10), @NGAYTHU DATE, @NGUOIGH NVARCHAR(50), @DIACHI NVARCHAR(100), @SDT VARCHAR(20))
AS
BEGIN
    UPDATE dbo.HOADON SET NGAYTHU = @NGAYTHU WHERE MAHOADON = @MAHOADON
	UPDATE dbo.NGUOIGIAMHO SET HOTEN = @NGUOIGH, DIACHI = @DIACHI, SDT = @SDT WHERE MAGH IN
	(
		SELECT HD.MAGH FROM dbo.NGUOIGIAMHO ngh INNER JOIN dbo.HOADON hd ON hd.MAGH = ngh.MAGH WHERE hd.MAHOADON = @MAHOADON
	)
END
GO	


CREATE PROC sp_InsertNGH (@MAGH CHAR(10), @HOTEN NVARCHAR(50), @DIACHI NVARCHAR(100), @SDT VARCHAR(20))
AS
BEGIN
    INSERT INTO dbo.NGUOIGIAMHO
    (
        MAGH,
        HOTEN,
        DIACHI,
        SDT
    )
    VALUES
    (   @MAGH,  -- MAGH - char(10)
        @HOTEN, -- HOTEN - nvarchar(50)
        @DIACHI, -- DIACHI - nvarchar(100)
        @SDT   -- SDT - varchar(20)
        )
END
GO	


CREATE PROC sp_AddMaGHtoKH (@MAGH CHAR(10))
AS
BEGIN
    UPDATE KHACHHANG SET MAGH = @MAGH WHERE MAKH IN (
	    SELECT kh.MAKH
	    FROM NGUOIGIAMHO gh INNER JOIN HOADON hd INNER JOIN PHIEUTIEM pt INNER JOIN KHACHHANG kh
	    ON kh.MAKH = pt.MAKH ON pt.MAPHIEUTIEM = hd.MAPHIEUTIEM ON hd.MAGH = gh.MAGH
	    WHERE gh.MAGH = @MAGH )
END
GO	


CREATE PROC sp_InsertHD (@MAHOADON CHAR(10), @CHIETKHAU FLOAT, @NGAYTHU DATE, @TONGTIEN BIGINT, @MAGH CHAR(10), @MATHUNGAN CHAR(10), @MAPHIEUTIEM CHAR(10))
AS
BEGIN
    INSERT INTO dbo.HOADON
    (
        MAHOADON,
        CHIETKHAU,
        NGAYTHU,
        TONGTIEN,
        MAGH,
        MATHUNGAN,
        MAPHIEUTIEM
    )
    VALUES
    (   @MAHOADON,        -- MAHOADON - char(10)
        @CHIETKHAU,       -- CHIETKHAU - float
        @NGAYTHU, -- NGAYTHU - date
        @TONGTIEN,         -- TONGTIEN - bigint
        @MAGH,        -- MAGH - char(10)
        @MATHUNGAN,        -- MATHUNGAN - char(10)
        @MAPHIEUTIEM         -- MAPHIEUTIEM - char(10)
        )
END
GO	


CREATE PROC sp_InsertKH (@MAKH CHAR(10), @TENKH CHAR(10), @NGAYSINH DATE, @GIOITINH NVARCHAR(4), @TIEUSU NVARCHAR(250), @MAGH CHAR(10))
AS
BEGIN
    INSERT INTO dbo.KHACHHANG
    (
        MAKH,
        TENKH,
        NGAYSINH,
        GIOITINH,
        TIEUSU,
        MAGH
    )
    VALUES
    (   @MAKH,        -- MAKH - char(10)
        @TENKH,       -- TENKH - nvarchar(20)
        @NGAYSINH, -- NGAYSINH - date
        @GIOITINH,       -- GIOITINH - nvarchar(4)
        @TIEUSU,       -- TIEUSU - nvarchar(250)
        @MAGH         -- MAGH - char(10)
        )
END
GO	